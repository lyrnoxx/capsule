<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Image Stitching Application</title>
    <!-- Load Tailwind CSS for modern, responsive styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Custom styles for better aesthetics */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f7f9fb;
        }
        .card {
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
        }
        /* Style for the file inputs, which are usually plain */
        input[type="file"]::file-selector-button {
            @apply bg-indigo-500 hover:bg-indigo-600 text-white font-semibold py-2 px-4 rounded-lg cursor-pointer transition duration-300 ease-in-out;
        }
        /* Custom spinner animation */
        .spinner {
            border-top-color: #3b82f6;
            border-left-color: #3b82f6;
            animation: spin 1s ease-in-out infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="min-h-screen flex items-start justify-center p-4 sm:p-8">

    <div class="w-full max-w-4xl mt-10">
        <h1 class="text-4xl font-extrabold text-gray-900 mb-2 text-center">Geospatial Stitcher</h1>
        <p class="text-lg text-gray-600 mb-8 text-center">Upload data and parameters to generate a stitched map.</p>

        <!-- Main Application Card -->
        <div id="app-container" class="card bg-white p-6 sm:p-10 rounded-xl">
            
            <form id="stitchingForm" class="space-y-6">
                
                <!-- File Inputs Section -->
                <div class="grid md:grid-cols-2 gap-6">
                    
                    <!-- 1. Image Folder Input -->
                    <div class="p-4 border-2 border-dashed border-indigo-200 rounded-lg bg-indigo-50">
                        <label for="imageFolder" class="block text-sm font-medium text-gray-700 mb-2">1. Select Image Folder (MANDATORY)</label>
                        <input
                            type="file"
                            id="imageFolder"
                            name="imageFolder"
                            webkitdirectory
                            directory
                            required
                            class="w-full text-sm text-gray-500 file:mr-4 file:py-1 file:px-3"
                            aria-label="Select the folder containing source images"
                        />
                        <p class="text-xs text-indigo-500 mt-1">Uses the 'webkitdirectory' attribute to select a folder.</p>
                    </div>

                    <!-- 2. Trajectory TXT File Input -->
                    <div class="p-4 border-2 border-dashed border-indigo-200 rounded-lg bg-indigo-50">
                        <label for="trajectoryFile" class="block text-sm font-medium text-gray-700 mb-2">2. Upload Trajectory (.txt) File (MANDATORY)</label>
                        <input
                            type="file"
                            id="trajectoryFile"
                            name="trajectoryFile"
                            accept=".txt"
                            required
                            class="w-full text-sm text-gray-500 file:mr-4 file:py-1 file:px-3"
                            aria-label="Upload the trajectory text file"
                        />
                        <p class="text-xs text-indigo-500 mt-1">Only accepts .txt files for trajectory data.</p>
                    </div>
                </div>

                <!-- Parameter Inputs Section -->
                <div class="grid sm:grid-cols-2 gap-6 pt-4">
                    <!-- 3. Width Parameter -->
                    <div>
                        <label for="mapWidth" class="block text-sm font-medium text-gray-700">3. Output Map Width (px)</label>
                        <input
                            type="number"
                            id="mapWidth"
                            name="mapWidth"
                            value="800"
                            min="100"
                            required
                            class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm p-3 border focus:border-indigo-500 focus:ring-indigo-500"
                            aria-label="Set the desired output map width in pixels"
                        />
                    </div>
                    
                    <!-- 4. Height Parameter -->
                    <div>
                        <label for="mapHeight" class="block text-sm font-medium text-gray-700">4. Output Map Height (px)</label>
                        <input
                            type="number"
                            id="mapHeight"
                            name="mapHeight"
                            value="600"
                            min="100"
                            required
                            class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm p-3 border focus:border-indigo-500 focus:ring-indigo-500"
                            aria-label="Set the desired output map height in pixels"
                        />
                    </div>
                </div>

                <!-- Submit Button -->
                <div class="pt-6">
                    <button
                        type="submit"
                        id="submitButton"
                        class="w-full flex items-center justify-center py-3 px-4 border border-transparent rounded-lg shadow-lg text-lg font-medium text-white bg-green-600 hover:bg-green-700 focus:outline-none focus:ring-4 focus:ring-green-500 focus:ring-opacity-50 transition duration-150 ease-in-out disabled:bg-gray-400"
                    >
                        Stitch Map
                    </button>
                </div>
            </form>

            <!-- Status and Result Display Area -->
            <div id="statusArea" class="mt-8">
                <!-- Status Messages (e.g., Processing, Error) -->
                <div id="messageBox" class="p-4 rounded-lg hidden" role="alert"></div>

                <!-- Output Image Container -->
                <div id="outputContainer" class="hidden mt-6 text-center">
                    <h3 class="text-xl font-semibold text-gray-800 mb-4">Stitched Map Output</h3>
                    <img id="stitchedMap" class="w-full h-auto max-h-[60vh] object-contain rounded-lg border-4 border-indigo-400 mx-auto" alt="Stitched Map Result" />
                    
                    <button id="resetButton" class="mt-4 py-2 px-6 bg-red-500 hover:bg-red-600 text-white font-medium rounded-lg shadow-md transition duration-150">
                        Start New Stitch
                    </button>
                </div>
            </div>
            
        </div>
    </div>

    <script type="text/javascript">
        // Global references
        const form = document.getElementById('stitchingForm');
        const submitButton = document.getElementById('submitButton');
        const messageBox = document.getElementById('messageBox');
        const outputContainer = document.getElementById('outputContainer');
        const stitchedMap = document.getElementById('stitchedMap');
        const resetButton = document.getElementById('resetButton');
        const API_ENDPOINT = '/api/stitch';

        // Function to update the message box with current status
        function updateStatus(message, type = 'info') {
            messageBox.textContent = message;
            messageBox.classList.remove('hidden', 'bg-red-100', 'text-red-800', 'bg-green-100', 'text-green-800', 'bg-blue-100', 'text-blue-800');
            
            let classes = '';
            if (type === 'error') {
                classes = 'bg-red-100 text-red-800';
            } else if (type === 'success') {
                classes = 'bg-green-100 text-green-800';
            } else {
                // Default to info/processing
                classes = 'bg-blue-100 text-blue-800';
            }
            messageBox.className = 'p-4 rounded-lg ' + classes;
        }

        // Function to show the loading state with a spinner
        function showProcessing(message = "Processing...") {
            submitButton.disabled = true;
            submitButton.innerHTML = `
                <svg class="spinner animate-spin -ml-1 mr-3 h-5 w-5 border-t-2 border-r-2 border-white rounded-full" viewBox="0 0 24 24"></svg>
                ${message}
            `;
            updateStatus('Starting map stitching process...', 'info');
            outputContainer.classList.add('hidden');
        }

        // Function to hide loading and reset button state
        function hideProcessing() {
            submitButton.disabled = false;
            submitButton.textContent = 'Stitch Map';
        }

        // Function to reset the UI after processing
        function resetApp() {
            form.reset();
            outputContainer.classList.add('hidden');
            messageBox.classList.add('hidden');
            hideProcessing();
        }

        // Exponential backoff fetch utility
        async function fetchWithRetry(url, options, maxRetries = 3) {
            for (let i = 0; i < maxRetries; i++) {
                try {
                    const response = await fetch(url, options);
                    if (response.status === 429 && i < maxRetries - 1) { // 429 Too Many Requests
                        const delay = Math.pow(2, i) * 1000 + Math.random() * 1000;
                        await new Promise(resolve => setTimeout(resolve, delay));
                        continue;
                    }
                    if (!response.ok) {
                        throw new Error(`Server responded with status: ${response.status} (${response.statusText})`);
                    }
                    return response;
                } catch (error) {
                    if (i === maxRetries - 1) {
                        throw error;
                    }
                    const delay = Math.pow(2, i) * 1000 + Math.random() * 1000;
                    await new Promise(resolve => setTimeout(resolve, delay));
                }
            }
        }


        // Main form submission handler
        form.addEventListener('submit', async (e) => {
            e.preventDefault();

            // Clear any previous status/output
            messageBox.classList.add('hidden');
            outputContainer.classList.add('hidden');

            const imageFolderInput = document.getElementById('imageFolder');
            const trajectoryFileInput = document.getElementById('trajectoryFile');
            const mapWidth = document.getElementById('mapWidth').value;
            const mapHeight = document.getElementById('mapHeight').value;

            if (imageFolderInput.files.length === 0 || trajectoryFileInput.files.length === 0) {
                updateStatus('Please select both an image folder and a trajectory file.', 'error');
                return;
            }

            // Start the loading state
            showProcessing("Uploading and Processing (This may take several minutes)...");

            const formData = new FormData();
            
            // Append folder files. Flask needs to handle these files with their relative paths.
            for (const file of imageFolderInput.files) {
                // The name 'images' must match the key Flask expects.
                formData.append('images', file, file.webkitRelativePath);
            }
            // Append trajectory file
            formData.append('trajectory', trajectoryFileInput.files[0], trajectoryFileInput.files[0].name);
            // Append parameters
            formData.append('width', mapWidth);
            formData.append('height', mapHeight);
            
            try {
                // Use fetch with retry for robust API communication
                const response = await fetchWithRetry(API_ENDPOINT, {
                    method: 'POST',
                    body: formData,
                    // Note: 'Content-Type': 'multipart/form-data' is NOT set here. 
                    // The browser handles it automatically when passing a FormData object.
                });
                
                const result = await response.json();
                
                if (result.success) {
                    // Assuming Flask returns a URL to the stitched image
                    handleSuccess(result.imageUrl, mapWidth, mapHeight);
                } else {
                    handleError(result.error || 'Unknown server error during processing.');
                }
                
            } catch (error) {
                // Handle network errors or errors thrown from fetchWithRetry/response check
                handleError(error.message);
            }
        });


        function handleSuccess(imageUrl, width, height) {
            hideProcessing();
            updateStatus('Map stitching complete! Input files have been deleted from the server.', 'success');
            
            // Set the output image source and dimensions
            stitchedMap.src = imageUrl;
            stitchedMap.alt = `Stitched map with width: ${width}, height: ${height}`;
            
            outputContainer.classList.remove('hidden');
            
            // Scroll to the output section
            outputContainer.scrollIntoView({ behavior: 'smooth', block: 'start' });
        }

        function handleError(errorMessage) {
            hideProcessing();
            updateStatus(`Error: Map stitching failed. ${errorMessage}`, 'error');
        }

        // Event listener for the reset button
        resetButton.addEventListener('click', resetApp);

    </script>
</body>
</html>
